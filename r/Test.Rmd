---
title: "MS&E 327 Homework 2"
date: "Due November 11th, 2019"
author: "Nicolas Bievre - nbievre"
fontsize: 10pt
header-includes:
  \usepackage{mathtools}
output:
    pdf_document:
      toc: no
      toc_depth: 3  
      number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE, comment=NA, echo=FALSE}
setwd("/Users/nicolasbievre/Documents/Education/2018 - 2020 Stanford University/MS&E 327/Homework/hw2")
library(knitr)
library(kableExtra)
library(magrittr)
library(ggplot2)
library(faraway)
library(DOS2)
library(RItools)
library(optmatch)
library(sensitivitymult)
```

# Problem 1

```{r, include=TRUE, comment=NA, echo=TRUE}
load("Problem_1-2/adynarski.Rdata")
source("Problem_1-2/utility.R")
```

## Part A

### Question 1

Looking at the graph bellow, the covariates that seem to be the most imbalanced in the dataset are: "faminc", "edm" and "edmissm".

```{r, include=TRUE, comment=NA, echo=TRUE}
plot(xBalance(zb ~ faminc + incmiss + black + hisp + afqtpct + edmissm + edm + female,
              data=dynarski))
```

\newpage
### Question 2

```{r, include=TRUE, comment=NA, echo=TRUE, message=FALSE}
ggplot(data=dynarski, aes(x=faminc)) + 
  geom_histogram(bins=20) + 
  facet_wrap(.~zb, scales="free") + 
  theme_bw()
```

\newpage
```{r, include=TRUE, comment=NA, echo=TRUE, message=FALSE}
ggplot(data=dynarski, aes(x=as.factor(incmiss))) + 
  geom_histogram(stat="count") + 
  facet_wrap(.~zb, scales="free") + 
  theme_bw()
```

\newpage
```{r, include=TRUE, comment=NA, echo=TRUE, message=FALSE}
ggplot(data=dynarski, aes(x=as.factor(black))) + 
  geom_histogram(stat="count") + 
  facet_wrap(.~zb, scales="free") + 
  theme_bw()
```

\newpage
```{r, include=TRUE, comment=NA, echo=TRUE, message=FALSE}
ggplot(data=dynarski, aes(x=as.factor(hisp))) + 
  geom_histogram(stat="count") + 
  facet_wrap(.~zb, scales="free") + 
  theme_bw()
```

\newpage
```{r, include=TRUE, comment=NA, echo=TRUE, message=FALSE}
ggplot(data=dynarski, aes(x=afqtpct)) + 
  geom_histogram(bins=30) + 
  facet_wrap(.~zb, scales="free") + 
  theme_bw()
```

\newpage
```{r, include=TRUE, comment=NA, echo=TRUE, message=FALSE}
ggplot(data=dynarski, aes(x=as.factor(edmissm))) + 
  geom_histogram(stat="count") + 
  facet_wrap(.~zb, scales="free") + 
  theme_bw()
```

\newpage
```{r, include=TRUE, comment=NA, echo=TRUE, message=FALSE}
ggplot(data=dynarski, aes(x=as.factor(edm))) + 
  geom_histogram(stat="count") + 
  facet_wrap(.~zb, scales="free") + 
  theme_bw()
```

\newpage
```{r, include=TRUE, comment=NA, echo=TRUE, message=FALSE}
ggplot(data=dynarski, aes(x=as.factor(female))) + 
  geom_histogram(stat="count") + 
  facet_wrap(.~zb, scales="free") + 
  theme_bw()
```

\newpage
## Question 3

The propensity scores are computed with the code bellow:

```{r, include=TRUE, comment=NA, echo=TRUE}
dynarski$prop <- glm(zb	~ faminc + incmiss + black + hisp + afqtpct + edmissm 
                     + edm + female,
                    family=binomial,
                    data=dynarski)$fitted.values
```

The density of the propensity scores is showed with the code bellow:

```{r, include=TRUE, comment=NA, echo=TRUE}
ggplot(data=dynarski, aes(x=prop, group=as.factor(zb), fill=as.factor(zb))) + 
  geom_density(alpha=0.5) + theme_bw()
```


\newpage
# Part B

## Question 1

```{r, include=TRUE, comment=NA, echo=TRUE}
covariates <- c("faminc", "incmiss", "black", "hisp", "afqtpct", "edmissm",
                "edm", "female")
```


```{r, include=TRUE, comment=NA, echo=TRUE}
match.nocaliper <- smahal(dynarski$zb, dynarski[,covariates])
ms.nocaliper <- pairmatch(match.nocaliper, data=dynarski)
plot(xBalance(zb	~ faminc + incmiss + black + hisp + afqtpct + edmissm + edm + female 
              + strata(ms.nocaliper) - 1,
              data=dynarski))
```

## Question 2

### Sub Question a

The average absolute difference in propensity scores within matched pairs is given by the code bellow:

```{r, include=TRUE, comment=NA, echo=TRUE}
data <- summarize.match(dynarski, ms.nocaliper)
formatC(mean(abs(data$prop.0 - data$prop.1)), format = "e", digits = 4)
```

The maximum absolute difference in propensity score is given by the code bellow:

```{r, include=TRUE, comment=NA, echo=TRUE}
formatC(max(abs(data$prop.0 - data$prop.1)), format = "e", digits = 4)
```


\newpage
### Sub Question b

```{r, include=TRUE, comment=NA, echo=TRUE}
match.withcaliper <- addcaliper(match.nocaliper, z=dynarski$zb, p=dynarski$prop, caliper=0.1)
ms.withcaliper <- pairmatch(match.withcaliper, data=dynarski)
plot(xBalance(zb	~ faminc + incmiss + black + hisp + afqtpct + edmissm + edm + female 
              + strata(ms.withcaliper) - 1,
              data=dynarski))
```


### Sub Question c

The average absolute difference in propensity scores within matched pairs is given by the code bellow:

```{r, include=TRUE, comment=NA, echo=TRUE}
data <- summarize.match(dynarski, ms.withcaliper)
formatC(mean(abs(data$prop.0 - data$prop.1)), format = "e", digits = 4)
```

The maximum absolute difference in propensity score is given by the code bellow:

```{r, include=TRUE, comment=NA, echo=TRUE}
formatC(max(abs(data$prop.0 - data$prop.1)), format = "e", digits = 4)
```


## Question 3

In both matches, we can see that the absolute standard difference strongly decreases before and after matching. The standard difference is nw close to zero for every covarite which is a sign that the two matches worked. Plus with the caliper, helps to reduce the average and the max of the absolute propensity scores.



\newpage
## Part C

## Question 1

### Sub Question a

```{r, include=TRUE, comment=NA, echo=TRUE}
ms.withcaliper.1to5 <- pairmatch(match.withcaliper, data=dynarski, control=5)
plot(xBalance(zb	~ faminc + incmiss + black + hisp + afqtpct + edmissm + edm + female 
              + strata(ms.withcaliper.1to5) - 1,
              data=dynarski))
```

\newpage
### Sub Question b

```{r, include=TRUE, comment=NA, echo=TRUE}
match.withcaliper.almost_exact <- addalmostexact(match.withcaliper,
                                                 z=dynarski$zb,
                                                 f=dynarski$edm, mult=5)
ms.withcaliper.1to5.almost_exact <- pairmatch(match.withcaliper.almost_exact,
                                  data=dynarski, control=5)
plot(xBalance(zb	~ faminc + incmiss + black + hisp + afqtpct + edmissm + edm + female 
              + strata(ms.withcaliper.1to5.almost_exact) - 1,
              data=dynarski))
```

\newpage
### Sub Question c

Although visually it seems that most absolute standardized differences were reduced, the average absolute difference in propensity scores within matched pairs increases after trying to force balance on the "edm" variable. Hence it does not improve the matching.

```{r, include=TRUE, comment=NA, echo=TRUE}
data <- summarize.match(dynarski, ms.withcaliper.1to5)
formatC(mean(abs(data$prop.0 - data$prop.1)), format = "e", digits = 4)
```

```{r, include=TRUE, comment=NA, echo=TRUE}
data <- summarize.match(dynarski, ms.withcaliper.1to5.almost_exact)
formatC(mean(abs(data$prop.0 - data$prop.1)), format = "e", digits = 4)
```

\newpage
## Question 2

### Sub Question a

Since trying to force balance on the "edm" variable did not help improve the matching, we remove that setp.

```{r, include=TRUE, comment=NA, echo=TRUE}
ms.withcaliper.1to15 <- pairmatch(match.withcaliper, data=dynarski, control=15)
plot(xBalance(zb	~ faminc + incmiss + black + hisp + afqtpct + edmissm + edm + female 
              + strata(ms.withcaliper.1to15) - 1,
              data=dynarski))
```



### Sub Question b

Looking at the chart we can say that the standardized differences is smaller with the 1 to 1 matching than for the 1 to 15 matching. This may indicate that we are trying to match too many treatment for a same control and hence we are decreasing the validity. This makes the matching more susceptible to confounding.

\newpage
# Problem 2

## Part A

### Question 1

We build the two matched sets with the code bellow:

```{r, include=TRUE, comment=NA, echo=TRUE}
match <- smahal(adynarski$z, adynarski[,covariates])
match <- addcaliper(match, z=adynarski$z, p=adynarski$prop, caliper=0.1)
ms.withcaliper.1to1 <- pairmatch(match, control=1, data=adynarski)
ms.withcaliper.1to15 <- pairmatch(match, control=15, data=adynarski)
```


### Question 2


```{r, include=TRUE, comment=NA, echo=TRUE}
data.senm <- cast.senm(adynarski, ms.withcaliper.1to1, two.outcomes=FALSE)
senm(data.senm$y, data.senm$z, mset=data.senm$mset, gamma = 1, inner = 0, trim = 'Inf')
```


```{r, include=TRUE, comment=NA, echo=TRUE}
data.senm <- cast.senm(adynarski, ms.withcaliper.1to1, two.outcomes=FALSE)
senm(data.senm$y, data.senm$z, mset=data.senm$mset, gamma = 1.2, inner = 0, trim = 'Inf')
```


\newpage
### Question 3

```{r, include=TRUE, comment=NA, echo=TRUE}
data.senm <- cast.senm(adynarski, ms.withcaliper.1to15, two.outcomes=FALSE)
senm(data.senm$y, data.senm$z, mset=data.senm$mset, gamma = 1, inner = 0, trim = 'Inf')
```

```{r, include=TRUE, comment=NA, echo=TRUE}
data.senm <- cast.senm(adynarski, ms.withcaliper.1to15, two.outcomes=FALSE)
senm(data.senm$y, data.senm$z, mset=data.senm$mset, gamma = 1.2, inner = 0, trim = 'Inf')
```


### Question 4

For the 1 to 1 matching, we end up rejecting the null hypothesis for $gamma = 1$ although we wouldn't for $gamma = 1.2$ therefore our intepretation is very sensitive to unmeasured confounding while for the 1 to 15 matching the p value changes less and our decision will be consistant no matter the gamma which means that it is more robust to unmeasured confounding.


\newpage
# Part B

### Question 1

```{r, include=TRUE, comment=NA, echo=TRUE}
quantile(adynarski$prop, c(.2, .4, .6, .8)) 
```

### Question 2

```{r, include=TRUE, comment=NA, echo=TRUE}
q20 = quantile(adynarski$prop, 0.2) 
q40 = quantile(adynarski$prop, 0.4) 
q60 = quantile(adynarski$prop, 0.6) 
q80 = quantile(adynarski$prop, 0.8) 
```

```{r, include=TRUE, comment=NA, echo=TRUE}
strata.1 <- as.numeric(0 <= adynarski$prop & adynarski$prop < q20)
strata.1.data <- adynarski[0 <= adynarski$prop & adynarski$prop < q20,]
strata.1.N1 <- sum(strata.1.data$z)
strata.1.N0 <- sum(1-strata.1.data$z)
strata.1.N <- strata.1.N0 + strata.1.N1
strata.1.tau = sum(strata.1.data$z*strata.1.data$y)/strata.1.N1 -
  sum((1-strata.1.data$z)*strata.1.data$y)/strata.1.N0
```

```{r, include=TRUE, comment=NA, echo=TRUE}
strata.2 <- as.numeric(q20 <= adynarski$prop & adynarski$prop < q40)
strata.2.data <- adynarski[q20 <= adynarski$prop & adynarski$prop < q40,]
strata.2.N1 <- sum(strata.2.data$z)
strata.2.N0 <- sum(1-strata.2.data$z)
strata.2.N <- strata.2.N0 + strata.2.N1
strata.2.tau = sum(strata.2.data$z*strata.2.data$y)/strata.2.N1 -
  sum((1-strata.2.data$z)*strata.2.data$y)/strata.2.N0
```

```{r, include=TRUE, comment=NA, echo=TRUE}
strata.3 <- as.numeric(q40 <= adynarski$prop & adynarski$prop < q60)
strata.3.data <- adynarski[q40 <= adynarski$prop & adynarski$prop < q60,]
strata.3.N1 <- sum(strata.3.data$z)
strata.3.N0 <- sum(1-strata.3.data$z)
strata.3.N <- strata.3.N0 + strata.3.N1
strata.3.tau = sum(strata.3.data$z*strata.3.data$y)/strata.3.N1 -
  sum((1-strata.3.data$z)*strata.3.data$y)/strata.3.N0
```

```{r, include=TRUE, comment=NA, echo=TRUE}
strata.4 <- as.numeric(q60 <= adynarski$prop & adynarski$prop < q80)
strata.4.data <- adynarski[q60 <= adynarski$prop & adynarski$prop < q80,]
strata.4.N1 <- sum(strata.4.data$z)
strata.4.N0 <- sum(1-strata.4.data$z)
strata.4.N <- strata.4.N0 + strata.4.N1
strata.4.tau = sum(strata.4.data$z*strata.4.data$y)/strata.4.N1 -
  sum((1-strata.4.data$z)*strata.4.data$y)/strata.4.N0
```

```{r, include=TRUE, comment=NA, echo=TRUE}
strata.5 <- as.numeric(q80 <= adynarski$prop & adynarski$prop <= 1)
strata.5.data <- adynarski[q80 <= adynarski$prop & adynarski$prop <= 1,]
strata.5.N1 <- sum(strata.5.data$z)
strata.5.N0 <- sum(1-strata.5.data$z)
strata.5.N <- strata.5.N0 + strata.5.N1
strata.5.tau = sum(strata.5.data$z*strata.5.data$y)/strata.5.N1 -
  sum((1-strata.5.data$z)*strata.5.data$y)/strata.5.N0
```


\newpage
```{r, include=TRUE, comment=NA, echo=TRUE}
data.frame("Strata"=c("[0, q20[", "[q20, q40[", "[q40, q60[", "[q60, q80[", "[q80, 1]"), 
           "Treatment" = c(strata.1.N1, strata.2.N1, strata.3.N1, strata.4.N1, strata.5.N1),
           "Control" = c(strata.1.N0, strata.2.N0, strata.3.N0, strata.4.N0, strata.5.N0))
```


\newpage
### Question 3

The stratified difference in mean is:

```{r, include=TRUE, comment=NA, echo=TRUE}
N <- as.numeric(length(adynarski$z))
tau = (strata.1.tau*strata.1.N + strata.2.tau*strata.2.N + strata.3.tau*strata.3.N +
         strata.4.tau*strata.4.N + strata.5.tau*strata.5.N) / N
formatC(tau, format = "e", digits = 4)
```

The variance is given by the code bellow:


```{r, include=TRUE, comment=NA, echo=TRUE}
Y.bar1 <- mean(adynarski$z*adynarski$y)
Y.bar0 <- mean((1-adynarski$z)*adynarski$y)

Y.0 <- (1-adynarski$z)*(adynarski$y - Y.bar0)^2
Y.1 <- adynarski$z*(adynarski$y - Y.bar1)^2

V.1 <- (1/strata.1.N1)*sum(strata.1*Y.1)/(strata.1.N - 1) +
  (1/strata.1.N0)*sum(strata.1*Y.0)/(strata.1.N - 1)

V.2 <- (1/strata.2.N1)*sum(strata.2*Y.1)/(strata.2.N - 1) +
  (1/strata.2.N0)*sum(strata.2*Y.0)/(strata.2.N - 1)

V.3 <- (1/strata.3.N1)*sum(strata.3*Y.1)/(strata.3.N - 1) +
  (1/strata.3.N0)*sum(strata.3*Y.0)/(strata.3.N - 1)

V.4 <- (1/strata.4.N1)*sum(strata.4*Y.1)/(strata.4.N - 1) +
  (1/strata.4.N0)*sum(strata.4*Y.0)/(strata.4.N - 1)

V.5 <- (1/strata.5.N1)*sum(strata.5*Y.1)/(strata.5.N - 1) +
  (1/strata.5.N0)*sum(strata.5*Y.0)/(strata.5.N - 1)

V <- (strata.1.N/N)^2*V.1 + (strata.2.N/N)^2*V.2 + (strata.3.N/N)^2*V.3 +
  (strata.4.N/N)^2*V.4 + (strata.5.N/N)^2*V.5
formatC(V, format = "e", digits = 4)
```



### Question 4

The $95%$ confidence interval is given by:


```{r, include=TRUE, comment=NA, echo=TRUE}
# Upper bound
formatC(1.96*sqrt(V/N) + tau, format = "e", digits = 4)

# Lower bound
formatC(-1.96*sqrt(V/N) + tau, format = "e", digits = 4)
```

The Neyman null hypothesis states that the average treatment effect is zero however 0 does not belong to our $95%$ confidence interval hence this is a strong evidence that we should reject the Neyan null hypothesis.


### Question 5

One of the major flow of this apporch is the disproportionary small ratio of treatment compared to control in the starta. A way to improve it would be to a 1 to k matching.







\newpage
# Problem 3

```{r, include=FALSE, comment=NA, echo=FALSE}
load("Problem_3/rerand.Rdata")
source("Problem_3/rerand.R")
```


```{r, include=TRUE, comment=NA, echo=TRUE}
N1 = 100
N0 = 100
N = N0 + N1
max_iter <- 10000

omega.crd <- c()
omega.scrd <- c()
omega.rerand <- c()
```


## Question 1

### Sub Question a


```{r, include=TRUE, comment=NA, echo=TRUE}
data <- science.1
Zobs = sample(c(rep(0, N0), rep(1, N1)), N, replace=FALSE)
data$Yobs = observe.Yobs(data, Zobs)
Tobs = sum(Zobs*data$Yobs)/N1 - sum((1-Zobs)*data$Yobs)/N0
T = c()
for(i in 1:max_iter) {
  Z = sample(Zobs, N, replace=FALSE)
  T[i] = sum(Z*data$Yobs)/N1 - sum((1-Z)*data$Yobs)/N0
}
formatC(mean(as.numeric(T >= Tobs)), format = "e", digits = 4)
```



### Sub Question b


```{r, include=TRUE, comment=NA, echo=TRUE}
data <- science.1
P = c()
alpha = 0.05
for(i in 1:200) {
  
  Zobs = sample(c(rep(0, N0), rep(1, N1)), N, replace=FALSE)
  data$Yobs = observe.Yobs(data, Zobs)
  Tobs = sum(Zobs*data$Yobs)/N1 - sum((1-Zobs)*data$Yobs)/N0
  
  T = c()
  for(j in 1:max_iter) {
    Z = sample(Zobs, N, replace=FALSE)
    T[j] = sum(Z*data$Yobs)/N1 - sum((1-Z)*data$Yobs)/N0
  }
  P[i] = mean(as.numeric(T >= Tobs))
}
omega.crd[1] <- mean(as.numeric(P <= 0.05))
formatC(omega.crd[1], format = "e", digits = 4)
```

The quantities $\omega_1^{crd}$ is the power of the test, basically how cobnfident we are in rejecting the null hypothesis based on the p value.


## Sub Question c

```{r, include=TRUE, comment=NA, echo=TRUE}
data <- science.2
P = c()
alpha = 0.05
for(i in 1:200) {
  
  Zobs = sample(c(rep(0, N0), rep(1, N1)), N, replace=FALSE)
  data$Yobs = observe.Yobs(data, Zobs)
  Tobs = sum(Zobs*data$Yobs)/N1 - sum((1-Zobs)*data$Yobs)/N0
  
  T = c()
  for(j in 1:max_iter) {
    Z = sample(Zobs, N, replace=FALSE)
    T[j] = sum(Z*data$Yobs)/N1 - sum((1-Z)*data$Yobs)/N0
  }
  P[i] = mean(as.numeric(T >= Tobs))
}
omega.crd[2] <- mean(as.numeric(P <= 0.05))
formatC(omega.crd[2], format = "e", digits = 4)
```

```{r, include=TRUE, comment=NA, echo=TRUE}
data <- science.3
P = c()
alpha = 0.05
for(i in 1:200) {
  
  Zobs = sample(c(rep(0, N0), rep(1, N1)), N, replace=FALSE)
  data$Yobs = observe.Yobs(data, Zobs)
  Tobs = sum(Zobs*data$Yobs)/N1 - sum((1-Zobs)*data$Yobs)/N0
  
  T = c()
  for(j in 1:max_iter) {
    Z = sample(Zobs, N, replace=FALSE)
    T[j] = sum(Z*data$Yobs)/N1 - sum((1-Z)*data$Yobs)/N0
  }
  P[i] = mean(as.numeric(T >= Tobs))
}
omega.crd[3] <- mean(as.numeric(P <= 0.05))
formatC(omega.crd[3], format = "e", digits = 4)
```

\newpage
```{r, include=TRUE, comment=NA, echo=TRUE}
data <- science.4
P = c()
alpha = 0.05
for(i in 1:200) {
  
  Zobs = sample(c(rep(0, N0), rep(1, N1)), N, replace=FALSE)
  data$Yobs = observe.Yobs(data, Zobs)
  Tobs = sum(Zobs*data$Yobs)/N1 - sum((1-Zobs)*data$Yobs)/N0
  
  T = c()
  for(j in 1:max_iter) {
    Z = sample(Zobs, N, replace=FALSE)
    T[j] = sum(Z*data$Yobs)/N1 - sum((1-Z)*data$Yobs)/N0
  }
  P[i] = mean(as.numeric(T >= Tobs))
}
omega.crd[4] <- mean(as.numeric(P <= 0.05))
formatC(omega.crd[4], format = "e", digits = 4)
```

```{r, include=TRUE, comment=NA, echo=TRUE}
data.frame("Science"=c(1, 2, 3, 4), "omega.crd"=omega.crd)
```

\newpage
## Questions 2


### Sub Question a

```{r, include=TRUE, comment=NA, echo=TRUE}
strata <- X > 0
```


```{r, include=TRUE, comment=NA, echo=TRUE}
data <- science.1
Zobs = rep(0, N)
Zobs.0 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
Zobs.1 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
Zobs[strata] <- Zobs.1
Zobs[!strata] <- Zobs.0
data$Yobs = observe.Yobs(data, Zobs)

Tobs = sum(Zobs*data$Yobs)/N1 - sum((1-Zobs)*data$Yobs)/N0
T = c()
for(i in 1:max_iter) {
  Z = sample(Zobs, N, replace=FALSE)
  T[i] = sum(Z*data$Yobs)/N1 - sum((1-Z)*data$Yobs)/N0
}
formatC(mean(as.numeric(T >= Tobs)), format = "e", digits = 4)
```

### Sub Question b


```{r, include=TRUE, comment=NA, echo=TRUE}
data <- science.1
P = c()
alpha = 0.05
for(i in 1:200) {
  
  Zobs = rep(0, N)
  Zobs.0 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
  Zobs.1 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
  Zobs[strata] <- Zobs.1
  Zobs[!strata] <- Zobs.0
  data$Yobs = observe.Yobs(data, Zobs)
  Tobs = sum(Zobs*data$Yobs)/N1 - sum((1-Zobs)*data$Yobs)/N0
  
  T = c()
  for(j in 1:max_iter) {
    Z = rep(0, N)
    Z.0 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
    Z.1 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
    Z[strata] <- Z.1
    Z[!strata] <- Z.0
    T[j] = sum(Z*data$Yobs)/N1 - sum((1-Z)*data$Yobs)/N0
  }
  P[i] = mean(as.numeric(T >= Tobs))
}
omega.scrd[1] <- mean(as.numeric(P <= 0.05))
formatC(omega.scrd[1], format = "e", digits = 4)
```


```{r, include=TRUE, comment=NA, echo=TRUE}
data <- science.2
P = c()
alpha = 0.05
for(i in 1:200) {
  
  Zobs = rep(0, N)
  Zobs.0 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
  Zobs.1 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
  Zobs[strata] <- Zobs.1
  Zobs[!strata] <- Zobs.0
  data$Yobs = observe.Yobs(data, Zobs)
  Tobs = sum(Zobs*data$Yobs)/N1 - sum((1-Zobs)*data$Yobs)/N0
  
  T = c()
  for(j in 1:max_iter) {
    Z = rep(0, N)
    Z.0 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
    Z.1 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
    Z[strata] <- Z.1
    Z[!strata] <- Z.0
    T[j] = sum(Z*data$Yobs)/N1 - sum((1-Z)*data$Yobs)/N0
  }
  P[i] = mean(as.numeric(T >= Tobs))
}
omega.scrd[2] <- mean(as.numeric(P <= 0.05))
formatC(omega.scrd[2], format = "e", digits = 4)
```

\newpage
```{r, include=TRUE, comment=NA, echo=TRUE}
data <- science.3
P = c()
alpha = 0.05
for(i in 1:200) {
  
  Zobs = rep(0, N)
  Zobs.0 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
  Zobs.1 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
  Zobs[strata] <- Zobs.1
  Zobs[!strata] <- Zobs.0
  data$Yobs = observe.Yobs(data, Zobs)
  Tobs = sum(Zobs*data$Yobs)/N1 - sum((1-Zobs)*data$Yobs)/N0
  
  T = c()
  for(j in 1:max_iter) {
    Z = rep(0, N)
    Z.0 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
    Z.1 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
    Z[strata] <- Z.1
    Z[!strata] <- Z.0
    T[j] = sum(Z*data$Yobs)/N1 - sum((1-Z)*data$Yobs)/N0
  }
  P[i] = mean(as.numeric(T >= Tobs))
}
omega.scrd[3] <- mean(as.numeric(P <= 0.05))
formatC(omega.scrd[3], format = "e", digits = 4)
```


```{r, include=TRUE, comment=NA, echo=TRUE}
data <- science.4
P = c()
alpha = 0.05
for(i in 1:200) {
  
  Zobs = rep(0, N)
  Zobs.0 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
  Zobs.1 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
  Zobs[strata] <- Zobs.1
  Zobs[!strata] <- Zobs.0
  data$Yobs = observe.Yobs(data, Zobs)
  Tobs = sum(Zobs*data$Yobs)/N1 - sum((1-Zobs)*data$Yobs)/N0
  
  T = c()
  for(j in 1:max_iter) {
    Z = rep(0, N)
    Z.0 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
    Z.1 = sample(c(rep(0, N0/2), rep(1, N1/2)), N/2, replace=FALSE)
    Z[strata] <- Z.1
    Z[!strata] <- Z.0
    T[j] = sum(Z*data$Yobs)/N1 - sum((1-Z)*data$Yobs)/N0
  }
  P[i] = mean(as.numeric(T >= Tobs))
}
omega.scrd[4] <- mean(as.numeric(P <= 0.05))
formatC(omega.scrd[4], format = "e", digits = 4)
```


The values of $w^{scrd}$ for each science are greater than for the complitly randomied design which means that the stratification helps improve the prower of the test.

```{r, include=TRUE, comment=NA, echo=TRUE}
data.frame("Science"=c(1, 2, 3, 4), "omega.scrd"=omega.scrd)
```


\newpage
## Questions 3



### Sub Question a

```{r, include=TRUE, comment=NA, echo=TRUE}
data <- science.1
Zobs = sample(c(rep(0, N0), rep(1, N1)), N, replace=FALSE)
data$Yobs = observe.Yobs(data, Zobs)

gamma <- 0.1
nb.assignments <- 0
rho <- c()
while(nb.assignments < 1000){
  rho_i = 2*gamma
  while(rho_i > gamma){
    Z = sample(Zobs, N, replace=FALSE)
    rho_i <- abs(sum(Z*X)/N1 - sum((1-Z)*X)/N0)
  }
  rho[nb.assignments] <- rho_i
  nb.assignments <- nb.assignments + 1
}
```




```{r, include=TRUE, comment=NA, echo=TRUE}
ggplot(data=data.frame("rho"=rho), aes(x=rho)) + 
  geom_histogram(bins=30) + 
  theme_bw()
```




### Sub Question b

```{r, include=TRUE, comment=NA, echo=TRUE}
gamma <- 0.1
```


```{r, include=TRUE, comment=NA, echo=TRUE}
data <- science.1
Zobs = sample(c(rep(0, N0), rep(1, N1)), N, replace=FALSE)

P = c()
alpha = 0.05
for(i in 1:200) {
  T = c()
  
  rho.temp = 2*gamma
  while(rho.temp > gamma){
    Zobs = sample(Zobs, N, replace=FALSE)
    rho.temp <- abs(sum(Z*X)/N1 - sum((1-Z)*X)/N0)
  }
  data$Yobs = observe.Yobs(data, Zobs)
  Tobs = sum(Zobs*data$Yobs)/N1 - sum((1-Zobs)*data$Yobs)/N0
  
  for(j in 1:max_iter) {
    
    rho.temp = 2*gamma
    while(rho.temp > gamma){
      Z = sample(Zobs, N, replace=FALSE)
      rho.temp <- abs(sum(Z*X)/N1 - sum((1-Z)*X)/N0)
    }
    T[j] = sum(Z*data$Yobs)/N1 - sum((1-Z)*data$Yobs)/N0
  }
  P[i] = mean(as.numeric(T >= Tobs))
}
omega.rerand[1] <- mean(as.numeric(P <= 0.05))
formatC(omega.rerand[1], format = "e", digits = 4)
```



\newpage
```{r, include=TRUE, comment=NA, echo=TRUE}
data <- science.2
Zobs = sample(c(rep(0, N0), rep(1, N1)), N, replace=FALSE)

P = c()
alpha = 0.05
for(i in 1:200) {
  T = c()
  
  rho.temp = 2*gamma
  while(rho.temp > gamma){
    Zobs = sample(Zobs, N, replace=FALSE)
    rho.temp <- abs(sum(Z*X)/N1 - sum((1-Z)*X)/N0)
  }
  data$Yobs = observe.Yobs(data, Zobs)
  Tobs = sum(Zobs*data$Yobs)/N1 - sum((1-Zobs)*data$Yobs)/N0
  
  for(j in 1:max_iter) {
    
    rho.temp = 2*gamma
    while(rho.temp > gamma){
      Z = sample(Zobs, N, replace=FALSE)
      rho.temp <- abs(sum(Z*X)/N1 - sum((1-Z)*X)/N0)
    }
    
    T[j] = sum(Z*data$Yobs)/N1 - sum((1-Z)*data$Yobs)/N0
  }
  P[i] = mean(as.numeric(T >= Tobs))
}
omega.rerand[2] <- mean(as.numeric(P <= 0.05))
formatC(omega.rerand[2], format = "e", digits = 4)
```



\newpage
```{r, include=TRUE, comment=NA, echo=TRUE}
data <- science.3
Zobs = sample(c(rep(0, N0), rep(1, N1)), N, replace=FALSE)

P = c()
alpha = 0.05
for(i in 1:200) {
  T = c()
  
  rho.temp = 2*gamma
  while(rho.temp > gamma){
    Zobs = sample(Zobs, N, replace=FALSE)
    rho.temp <- abs(sum(Z*X)/N1 - sum((1-Z)*X)/N0)
  }
  data$Yobs = observe.Yobs(data, Zobs)
  Tobs = sum(Zobs*data$Yobs)/N1 - sum((1-Zobs)*data$Yobs)/N0
  
  for(j in 1:max_iter) {
    
    rho.temp = 2*gamma
    while(rho.temp > gamma){
      Z = sample(Zobs, N, replace=FALSE)
      rho.temp <- abs(sum(Z*X)/N1 - sum((1-Z)*X)/N0)
    }
    
    T[j] = sum(Z*data$Yobs)/N1 - sum((1-Z)*data$Yobs)/N0
  }
  P[i] = mean(as.numeric(T >= Tobs))
}
omega.rerand[3] <- mean(as.numeric(P <= 0.05))
formatC(omega.rerand[3], format = "e", digits = 4)
```


\newpage
```{r, include=TRUE, comment=NA, echo=TRUE}
data <- science.4
Zobs = sample(c(rep(0, N0), rep(1, N1)), N, replace=FALSE)

P = c()
alpha = 0.05
for(i in 1:200) {
  T = c()
  
  rho.temp = 2*gamma
  while(rho.temp > gamma){
    Zobs = sample(Zobs, N, replace=FALSE)
    rho.temp <- abs(sum(Z*X)/N1 - sum((1-Z)*X)/N0)
  }
  data$Yobs = observe.Yobs(data, Zobs)
  Tobs = sum(Zobs*data$Yobs)/N1 - sum((1-Zobs)*data$Yobs)/N0
  
  for(j in 1:max_iter) {
    
    rho.temp = 2*gamma
    while(rho.temp > gamma){
      Z = sample(Zobs, N, replace=FALSE)
      rho.temp <- abs(sum(Z*X)/N1 - sum((1-Z)*X)/N0)
    }
    
    T[j] = sum(Z*data$Yobs)/N1 - sum((1-Z)*data$Yobs)/N0
  }
  P[i] = mean(as.numeric(T >= Tobs))
}
omega.rerand[4] <- mean(as.numeric(P <= 0.05))
formatC(omega.rerand[4], format = "e", digits = 4)
```


By upper bounded the the absolute value of the difference in means for covariates, we improved the power ofthe test for each ofthe sciences. Which makes sense since we are limitating the difference in means for covariates.

```{r, include=TRUE, comment=NA, echo=TRUE}
data.frame("Science"=c(1, 2, 3, 4), "omega.rerand"=omega.rerand)
```



\newpage
## Question 4


```{r, include=TRUE, comment=NA, echo=TRUE}
omega = data.frame("Design"=c(rep("crn", 4), rep("scrn", 4), rep("rerand", 4)),
                   "Science"=c(rep(c(1, 2, 3, 4), 3)),
                   "Omega"=c(omega.crd, omega.scrd, omega.rerand))
ggplot(data=omega, aes(x=Science, y=Omega)) +
  geom_line(aes(colour=Design))
```



